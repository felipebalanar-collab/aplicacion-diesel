import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const diagnosticProcedureArticles = [
  {
    title: "Diagnóstico Turbocompresor Diesel - Síntomas y Pruebas Específicas",
    keywords: ["turbo diagnosis", "turbo boost bajo", "turbo defectuoso", "síntomas turbo", "prueba presión boost"],
    answer: "[DIAGNOSTICO TURBO DIESEL - PROCEDIMIENTO COMPLETO]\n\n[SÍNTOMAS = TURBO PROBLEMÁTICO]\n\n1. SIN PODER EN ACELERACIÓN:\n   - Motor lentos, falta respuesta\n   - RPM sube pero velocidad NO sube\n   - Carga pero sin presión boost\n   - Causa típica: Presión boost falta\n\n2. HUMO NEGRO EXCESIVO:\n   - Negro profundo desde escape\n   - Potencia pero mucho humo\n   - Causa: Inyección demasiado rica = turbo no comprime suficiente\n   - O: Escape bloqueado, turbo retiene presión\n\n3. RUIDO SILBANTE ANORMAL:\n   - Sonido agudo desde motor\n   - Típicamente durante aceleración\n   - Causa 1: Aire filtrando en línea entrada turbo\n   - Causa 2: Turbo rotación anormal (rodamientos desgastados)\n\n4. HUMO BLANCO/AZUL:\n   - Blanco = aceite quemado\n   - Azul = aceite pasando sello\n   - Causa: Turbo rodamientos gastados, sello dañado\n   - Peligro: Motor requiere cambio aceite frecuente\n\n5. CONSUMO ACEITE EXCESIVO:\n   - Nivel baja rápidamente entre cambios\n   - Turbo consume aceite internamente\n   - Síntoma claro de desgaste turbo\n\n6. CÓDIGO OBD P0234 O P0299:\n   - P0234 = Boost exceisvo\n   - P0299 = Boost insuficiente\n   - Leer con escáner para precisión\n\n[PASO 1: INSPECCION VISUAL]\n- Motor apagado, frío (esperar 30 min después parar)\n- Localizar turbo (generalmente debajo del motor)\n- Inspeccionar:\n  • Tubo entrada turbo: ¿Suelto? ¿Grietas? ¿Fugas aire?\n  • Tubo salida: ¿Fugas? ¿Conexiones sueltas?\n  • Línea aceite entrada turbo: ¿Fugas aceite?\n  • Línea aceite salida: ¿Goteo excesivo?\n  • Turbo carcasa: ¿Grietas visibles? ¿Decoloración? (ROJO/AZUL = sobrecalentamiento)\n- Cualquier fuga = problema turbo\n\n[PASO 2: PRUEBA PRESION BOOST\n★ NECESITA MANÓMETRO BOOST ESPECIFICO ★\n\nConexión manómetro:\n- Localizar punto medición boost:\n  • Entrada intercooler (después turbo)\n  • Línea salida turbo antes válvula wastegate\n  • Conector diagnóstico (si vehículo tiene)\n- Conectar manómetro presión 0-300 kPa\n- Asegurar conexión firme\n\nLecturas esperadas:\n- Ralentí (1000 RPM): 0 kPa (nada)\n- 1500 RPM: 0-20 kPa\n- 2000 RPM: 50-100 kPa\n- 2500 RPM: 100-150 kPa (depende motor)\n- 3000+ RPM: 150-250 kPa máximo\n- Nunca debe exceder especificación de motor\n\nResultados interpretación:\n- Presión AUMENTA con RPM = NORMAL\n- Presión constantemente 0 = PROBLEMA\n- Presión sube lentamente = Turbo débil\n- Presión salta erraticamente = Válvula wastegate defectuosa\n\n[PASO 3: VERIFICACION LINEA ENTRADA AIRE]\n- Motor apagado\n- Desconectar manguera entrada turbo\n- Inspeccionar visualmente interno:\n  • ¿Aspecto limpio? = Normal\n  • ¿Polvoso/sucio? = Filtro aire defectuoso\n  • ¿Resina pegajosa? = Combustible quemado\n- Raspar con dedo: Debe estar limpio\n- Si sucio: Problema sistema aire\n- Reconectar manguera firmemente\n\n[PASO 4: VERIFICACION VÁLVULA WASTEGATE]\n- Localizar válvula descarga turbo\n- Típicamente soldada al turbo carcasa\n- Motor apagado:\n  1. Desconectar línea vacío (si existe)\n  2. Aplicar vacío con bomba manual\n  3. Válvula DEBE abrirse\n  4. Liberar vacío = DEBE cerrarse\n  5. Si no abre/cierra: Atascada, REEMPLAZAR\n\n[PASO 5: DIAGNOSTICO ELECTRON/SOLENOIDE (Turbo VGT)\nTurbo Variable Geometry (moderno):\n- Tiene actuador electrónico\n- Voltaje control: 12V típicamente\n- Medir continuidad solenoide:\n  • Desconectar conector\n  • Multímetro resistencia\n  • Típicamente 6-15 ohms\n  • Si abierto (infinito) = REEMPLAZAR actuador\n  • Si muy bajo (<1 ohm) = cortocircuito, REEMPLAZAR\n\n[PASO 6: PRUEBA RODAMIENTOS TURBO\n★ REQUIERE ESPECIALISTA EQUIPO ★\n- Coger rotor turbo (turbina)\n- Girar CON MUCHO CUIDADO\n- Debe rotar SUAVEMENTE sin fricción\n- Si hay fricción/sonido rasguño = Rodamientos gastados\n- Si rotor toca carcasa = Turbo internamente dañado\n- Cualquier duda: REEMPLAZAR turbo\n\n[PASO 7: PRESION ACEITE TURBO\n- Turbo requiere 3-5 bar presión aceite\n- Medir presión aceite motor:\n  • Ralentí: Debe estar 2-4 bar\n  • 2000 RPM: Debe estar 3-5 bar\n  • Si presión baja: Turbo sufre\n  • Cambiar aceite y filtro resuelve muchos problemas turbo\n\n[DECISION FINAL TURBO]\nSI TODO NORMAL EN PRUEBAS:\n  - Cambiar aceite y filtro\n  - Limpiar filtro aire\n  - Verificar inyector diesel (puede ser culpable)\n  - Problema: Probablemente combustible pobre o inyección\n\nSI PRESION BOOM BAJO:\n  - Válvula wastegate defectuosa\n  - Fugas aire línea entrada/salida\n  - Turbo internamente desgastado\n  - Cargar en especialista o REEMPLAZAR turbo\n\nSI PRESION BOOST ERRATIC:\n  - Válvula wastegate intermitente\n  - Solenoide VGT defectuoso\n  - Sensor MAP defectuoso\n  - Leer código OBD para precisión\n"
  },
  {
    title: "Diagnóstico de Pérdida de Potencia - Árbol de Decisión Técnica",
    keywords: ["pérdida potencia", "motor débil", "falta aceleración", "diagnóstico potencia", "limp mode"],
    answer: "[DIAGNOSTICO PERDIDA POTENCIA - ÁRBOL DECISIONAL]\n\n[DEFINICION]\nPérdida potencia = Motor arranca OK, pero aceleración lenta o nula\nMotor puede estar en \"Limp Mode\" = Potencia reducida a 50% máximo\n\n[VERIFICACION INICIAL (1 minuto)]\n\n1. ¿Hay código de falla OBD?\n   - Conectar escáner\n   - SÍ codigo = Leer qué dice\n   - NO codigo = Problema mecánico o sensor intermitente\n\n2. ¿Se activó luz SERVICIOS/CEL?\n   - SÍ = Sistema en modo protección\n   - NO = Problema progresivo\n\n3. ¿Cuándo started? \n   - Gradual (semanas) = Sensor desgastado\n   - Súbito (hoy) = Falta combustible o encendido\n\n[ARBOL DECISIONAL - SEGUIR PASO A PASO]\n\n┌─ ¿Hay CODIGO P0087 o P0088 (Presión combustible)?\n│  ✓ SÍ ────────────> Problema combustible\n│  │                   Ver diagnóstico presión GDI\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Há CODIGO P0299 o P0234 (Boost turbo)?\n│  ✓ SÍ ────────────> Problema turbo\n│  │                   Ver diagnóstico turbo diesel\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Hay CODIGO P0134-P0141 (Sensor O2)?\n│  ✓ SÍ ────────────> Problema mezcla aire-combustible\n│  │                   Sensor O2 defectuoso\n│  │                   O inyector defectuoso\n│  │                   REEMPLAZAR sensor O2\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Hay CODIGO P0101 o P0102 (MAF sensor)?\n│  ✓ SÍ ────────────> Sensor flujo aire defectuoso\n│  │                   ECU piensa motor hambriento\n│  │                   LIMPIAR o REEMPLAZAR MAF\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Hay CODIGO P0335 (CKP sensor)?\n│  ✓ SÍ ────────────> Sensor posición cigüeñal\n│  │                   Motor no puede sincronizar\n│  │                   REEMPLAZAR sensor CKP\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Hay CODIGO P0011-P0014 (VVT/Árbol levas)?\n│  ✓ SÍ ────────────> Sistema distribución variable\n│  │                   Solenoide defectuoso o aceite sucio\n│  │                   CAMBIAR aceite O REEMPLAZAR solenoide\n│  └ NO ──────────────> Continuar\n│\n├─ ¿Hay CODIGO MULTIPLE (>3 códigos)?\n│  ✓ SÍ ────────────> LIMP MODE activado\n│  │                   ECU limita potencia por seguridad\n│  │                   Problema crítico presente\n│  │                   ESCANEAR todos códigos\n│  │                   REPARAR problema crítico primero\n│  └ NO ──────────────> Continuar\n│\n└─ SI NO HAY CODIGO: DIAGNÓSTICO MECÁNICO\n   1. Revisar filtro aire (sucio = restricción)\n   2. Revisar presión combustible (manual prueba)\n   3. Revisar bujías (desgaste o gapping)\n   4. Revisar compresión cilindros\n   5. Revisar válvulas (depósitos carbón)\n   6. Revisar inyectores (spray pattern)\n\n[PRUEBAS ESPECÍFICAS SEGUN SINTOMA]\n\nPotencia baja RALENTI SOMENTE:\n  - Inyector parcialmente bloqueado\n  - Sensor MAF sucio\n  - Válvula PCV atascada\n  - Cambiar aceite + filtro resuelve 60%\n\nPotencia baja TODOS RPM:\n  - Presión combustible real está baja\n  - Filtro aire muy sucio\n  - Múltiples fallos (códigos múltiples)\n\nPotencia baja ACELERACION FUERTE:\n  - Turbo débil o bloqueado\n  - Intercooler atascado\n  - Presión boost no se alcanza\n\nMotor NO responde PEDAL ACELERADOR:\n  - Sensor TPS defectuoso\n  - Cableado acelerador suelto\n  - ECU ignora comando pedal\n  - Código típico K0122/P0123\n\nMotor CORTA en picos RPM:\n  - Limitador voltaje ECU activado\n  - Combustible o presión insuficiente\n  - Sistema REV limitado (esperado)\n\n[LIMP MODE - CUANDO SE ACTIVA]\nECU LIMITA POTENCIA A 50% EN ESTOS CASOS:\n- Múltiples códigos de falla presentes\n- Sensor crítico fuera de rango\n- Temperatura motor demasiado alta\n- Presión turbo fuera especificación crítica\n- Sistema seguridad se activó\n\nCÓMO SALIR LIMP MODE:\n1. Identificar código fault\n2. Reparar problema root cause\n3. Borrar código OBD con escáner\n4. Motor es reinicia automáticamente en modo normal\n5. Si problema persiste, vuelve a Limp Mode\n\n[DIAGNOSTICO SIN ESCANER (Básico)]\nPrueba Manual 1: Compresión\n  - Si <120 PSI = Válvulas o anillos problemáticos\n  - Potencia baja esperado\n\nPrueba Manual 2: Spark test (Gasolina)\n  - Sacar bujía\n  - Conectar a cable encendido\n  - Acerca a masa motor\n  - Debe haber chispa azul fuerte\n  - Chispa débil = bobina defectuosa\n\nPrueba Manual 3: Olor combustible\n  - Si olor muy fuerte = inyector gotea\n  - Mezcla muy rica = potencia baja\n\nPrueba Manual 4: Color escape\n  - Negro = mezcla rica\n  - Blanco = mezcla pobre O agua entrando\n  - Azul = aceite quemado\n"
  },
  {
    title: "Procedimiento de Cambio de Aceite Motor - Especificaciones Técnicas",
    keywords: ["cambio aceite", "especificación aceite", "viscosidad aceite", "sae", "acea", "procedimiento cambio"],
    answer: "[CAMBIO DE ACEITE MOTOR - PROCEDIMIENTO PROFESIONAL]\n\n[ESPECIFICACIONES ACEITE - CRÍTICO]\n\nVisecosidad SAE:\n- 0W-20: Flujo FRIO, viscosidad CALIENTE 20\n- 5W-30: Flujo FRIO 5W, viscosidad CALIENTE 30\n- 10W-40: Flujo FRIO 10W, viscosidad CALIENTE 40\n- 15W-50: Flujo FRIO 15W, viscosidad CALIENTE 50\n\nDiesel típico: 5W-30 o 5W-40\nGasolina típico: 0W-20 o 5W-30\n★ NUNCA cambiar viscosidad sin consultar manual OEM ★\n\nEspecificación ACEA (Europea):\n- A3/B3: Motor gasolina/diesel turbo\n- A5/B5: Aceite síntético moderna\n- C1-C4: Motores con tratamiento emisiones\nVerificar manual del vehículo\n\nTipo Aceite:\n- Mineral: Básico, bueno para motores viejos\n- Semi-Sintético: Balance precio/performance\n- Sintético: Mejor protección, más caro, intervalo mayor\n\nIntervalo de Cambio:\n- Mineral: Cada 5,000 km\n- Semi-Sintético: Cada 7,500-10,000 km\n- Sintético: Cada 10,000-15,000 km\n- Diesel: A veces +20% más intervalo\n\n[PASO 1: PREPARACION]\n1. Vehículo sobre superficie plana\n2. Motor encendido 5 minutos (calentar aceite, fluye mejor)\n3. Motor apagado, esperar 3 minutos\n4. Colocar bajo el motor (gato)\n5. Levantar vehículo seguramente (soportes)\n6. Motor DEBE estar FRIO ante de trabajar bajo\n\n[PASO 2: ACCESO AL TAPÓN DRENAJE]\n1. Localizar tapón drenaje (típicamente parte inferior motor)\n2. Remover protección plástica si existe\n3. Colocar bandeja drenaje bajo tapón\n4. Aflojando tapón con llave (típicamente 17-20mm)\n5. Girar manualmente (CUIDADO: Puede estar caliente)\n6. Sacar tapón completamente\n7. Drenar aceite completamente (5-10 minutos mínimo)\n\n[PASO 3: INSPECCIÓN ACEITE DRENADO]\n- Color típico nuevo: Ámbar/Dorado claro\n- Color normal usado: Marrón oscuro\n- Color problemático NEGRO: Cambio vencido MUCHO\n- Color plateado: METAL en aceite = PROBLEMA MOTOR\n- Color lechoso/batido: AGUA en aceite = Problema grave\n- Si agua o metal: Revisar motor antes continuar\n\n[PASO 4: LIMPIEZA ÁREA]\n1. Limpiar zona alrededor tapón con trapo\n2. Inspeccionar rosca tapón:\n   - Si está rota = No puede sellar\n   - Si está dañada = REEMPLAZAR tapón\n3. Limpiar rosca con trapo seco\n\n[PASO 5: INSPECCIÓN FILTRO ACEITE]\n- Localizar filtro aceite (típicamente costado motor)\n- Puede ser:\n  • Cartucho (tornillo superior)\n  • Cilíndrico (rosca lateral/inferior)\n\nPara cartucho:\n1. Aflojador tornillo central\n2. Sacar cartucho\n3. Inspeccionar elemento:\n   - Muy sucio = cambio vencido\n   - Depósitos metálicos = Problema motor\n4. Limpiar rosca en carcasa\n\nPara cilíndrico:\n1. Usar llave filtro aceite\n2. Girar anticlockwise hasta soltar\n3. Drenar más aceite en bandeja\n4. Inspeccionar elemento\n\n[PASO 6: REEMPLAZO FILTRO]\n1. Aplicar aceite nuevo en anillo sello del filtro nuevo\n2. Roscar filtro a mano (3/4 vueltas después contacto)\n3. NO apretar con llave = se sella solo\n4. Si está sello en viejo = REMOVER antes instalar nuevo\n\n[PASO 7: TRATAMIENTO TAPÓN DRENAJE]\n1. Inspeccionar anillo sello (O-ring) en tapón\n2. Si gastado/aplastado = REEMPLAZAR anillo o tapón\n3. Si está bien = Reutilizar\n4. Si NUEVO tapón = Típicamente incluye anillo nuevo\n\n[PASO 8: INSTALACION TAPÓN NUEVO]\n1. Roscar tapón manualmente a carcasa\n2. Una vez en contacto: Apretar con llave\n3. Presión típica: 25-35 Nm (18-26 lb-ft)\n4. NO apretar excesivamente (puede rasgarse rosca)\n5. NO dejar suelto (fugas de aceite)\n\n[PASO 9: LLENADO ACEITE NUEVO]\n1. Localizar tapa aceite motor (parte superior, tapa negra típicamente)\n2. Remover tapa\n3. Insertar embudo\n4. Verter cantidad especificada (ver manual = típicamente 4-6 litros)\n5. No llenar hasta tope (motor requiere espacio)\n6. Roscar tapa aceite nuevamente\n\n[PASO 10: VERIFICACION NIVEL]\n1. Motor apagado, esperar 2 minutos\n2. Quitar medidor aceite (varilla o digital)\n3. Medidor Varilla:\n   - Limpiar con trapo\n   - Reinsertar completamente\n   - Extraer nuevamente\n   - Debe estar entre MIN-MAX marcas\n4. Medidor Digital:\n   - Presionar botón verificación\n   - Debe mostrar en rango OK\n5. Si bajo: Agregar un poco más, repetir verificación\n\n[PASO 11: DRENAJE SISTEMA]\n1. Motor apagado, esperar completamente frío (30 minutos)\n2. Remover bajo motor\n3. Bajar vehículo\n4. Recolectar aceite drenado en bolsa/botella\n5. NUNCA vaciar aceite en piso\n6. Llevar a centro reciclaje\n\n[PASO 12: VERIFICACION FINAL]\n1. Encender motor\n2. Escuchar: Debe sonar normal\n3. Típicamente 5-10 segundos luz presión se apaga\n4. Si luz persiste >15 seg = Problema\n5. Motor idle 2-3 minutos\n6. Revisar bajo motor para fugas\n7. Apagar motor\n8. Esperar 2 minutos, revisar nivel nuevamente\n\n[RESET INDICADOR CAMBIO ACEITE]\nVarios sistemas:\n1. Botón RESET en panel (Presionar 10 segundos llave ON)\n2. Menú del escáner (Scan tool reset service reminder)\n3. Combinación teclas (Varía por fabricante)\n4. Manual específico del vehículo requerido\n\n[ERRORES COMUNES A EVITAR]\n❌ No cambiar filtro (solo tapón drenaje)\n❌ Llenar aceite hasta tope (se calienta, puede rebosarse)\n❌ No limpiar área antes (suciedad entra carcasa)\n❌ Apretar filtro con llave (sello se daña, fugas)\n❌ Mezclar aceites de viscosidad diferente\n❌ Usar filtro incorrecto para motor\n❌ No resetear indicador de servicio\n\n[FRECUENCIA DE CAMBIO]\nMotor Gasolina Turbo:\n- Sintético: 10,000 km\n- Semi-Sintético: 7,500 km\n\nMotor Diesel Turbo:\n- Sintético: 15,000 km\n- Semi-Sintético: 10,000 km\n\nMotor Híbrido:\n- Por lo general como gasolina\n- Aceite se calienta más\n- Cambiar puede ser necesario + frecuentemente\n"
  }
];

async function loadDiagnosticProcedureArticles() {
  console.log('Iniciando carga de Procedimientos de Diagnóstico Específicos...');
  console.log(`Total de articulos a insertar: ${diagnosticProcedureArticles.length}\n`);

  for (const article of diagnosticProcedureArticles) {
    try {
      const { error } = await supabase
        .from('assistant_kb')
        .insert([
          {
            title: article.title,
            keywords: article.keywords,
            answer: article.answer,
          }
        ]);

      if (error) {
        console.log(`❌ Error al insertar: ${article.title}`, error.message);
      } else {
        console.log(`✅ Insertado: ${article.title}`);
      }
    } catch (err) {
      console.log(`❌ Error: ${err.message}`);
    }
  }

  console.log(`\n✅ Proceso completado - Procedimientos de Diagnóstico`);
  console.log(`Total procesado: ${diagnosticProcedureArticles.length} articulos`);
}

loadDiagnosticProcedureArticles();
